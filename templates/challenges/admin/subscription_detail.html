{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Subscription: {{ subscription.user.email }} - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/courses.css' %}">
{% endblock %}

{% block admin_content %}
<div class="admin-header">
    <div class="tile-wrap">
        <div class="admin-header-content">
            <h1>
                <span class="material-icons">card_membership</span>
                Challenge Subscription Details
            </h1>
            <div class="admin-actions">
                <a href="{% url 'challenges:admin_subscriptions_list' %}" class="btn btn-secondary">
                    <span class="material-icons">arrow_back</span>
                    Back to List
                </a>
                <a href="{% url 'challenges:admin_subscription_edit' subscription.id %}" class="btn btn-warning">
                    <span class="material-icons">edit</span>
                    Edit Subscription
                </a>
            </div>
        </div>
    </div>
</div>

<div class="tile-wrap">
    <div class="admin-content-grid">
        <!-- Subscription Details -->
        <div class="admin-content-main">
        <!-- Subscription Information -->
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <span class="material-icons">info</span>
                    Subscription Information
                </h3>
            </div>
            <div class="card-content">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>User:</label>
                        <div class="user-info">
                            <strong>{{ subscription.user.full_name_or_email }}</strong>
                            <small>{{ subscription.user.email }}</small>
                        </div>
                    </div>
                    <div class="detail-item">
                        <label>Plan:</label>
                        <div class="plan-info">
                            <strong>{{ subscription.plan.name }}</strong>
                            <small>{{ subscription.plan.duration_display }} - ${{ subscription.plan.price }}</small>
                        </div>
                    </div>
                    <div class="detail-item">
                        <label>Status:</label>
                        <span class="status-badge status-{{ subscription.status }}">
                            {{ subscription.get_status_display }}
                        </span>
                    </div>
                    <div class="detail-item">
                        <label>Amount Paid:</label>
                        <span class="amount">${{ subscription.amount_paid }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Start Date:</label>
                        <span>{{ subscription.start_date|date:"M d, Y g:i A" }}</span>
                    </div>
                    <div class="detail-item">
                        <label>End Date:</label>
                        <span>
                            {% if subscription.end_date %}
                                {{ subscription.end_date|date:"M d, Y g:i A" }}
                            {% else %}
                                <span class="text-muted">Unlimited</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if subscription.status == 'active' %}
                    <div class="detail-item">
                        <label>Time Remaining:</label>
                        <span class="time-remaining">{{ subscription.time_remaining }}</span>
                    </div>
                    {% endif %}
                    {% if subscription.payment_reference %}
                    <div class="detail-item">
                        <label>Payment Reference:</label>
                        <span class="payment-ref">{{ subscription.payment_reference }}</span>
                    </div>
                    {% endif %}
                    {% if subscription.stripe_payment_intent_id %}
                    <div class="detail-item">
                        <label>Stripe Payment ID:</label>
                        <span class="payment-id">{{ subscription.stripe_payment_intent_id }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Plan Details -->
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <span class="material-icons">description</span>
                    Plan Details
                </h3>
            </div>
            <div class="card-content">
                <div class="plan-details">
                    <h4>{{ subscription.plan.name }}</h4>
                    <p>{{ subscription.plan.description }}</p>
                    
                    {% if subscription.plan.features %}
                    <div class="plan-features">
                        <h5>Features:</h5>
                        <ul>
                            {% for feature in subscription.plan.features %}
                            <li>{{ feature }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="plan-pricing">
                        <div class="price-info">
                            <span class="current-price">${{ subscription.plan.price }}</span>
                            {% if subscription.plan.original_price and subscription.plan.original_price > subscription.plan.price %}
                            <span class="original-price">${{ subscription.plan.original_price }}</span>
                            <span class="discount">{{ subscription.plan.discount_percentage }}% off</span>
                            {% endif %}
                        </div>
                        <div class="duration">{{ subscription.plan.duration_display }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timestamps -->
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <span class="material-icons">schedule</span>
                    Timestamps
                </h3>
            </div>
            <div class="card-content">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Created:</label>
                        <span>{{ subscription.created_at|date:"M d, Y g:i A" }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Last Updated:</label>
                        <span>{{ subscription.updated_at|date:"M d, Y g:i A" }}</span>
                    </div>
                    {% if subscription.pending_expires_at %}
                    <div class="detail-item">
                        <label>Pending Expires:</label>
                        <span>{{ subscription.pending_expires_at|date:"M d, Y g:i A" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="admin-content-sidebar">
        <!-- Quick Actions -->
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <span class="material-icons">flash_on</span>
                    Quick Actions
                </h3>
            </div>
            <div class="card-content">
                <div class="quick-actions">
                    <a href="{% url 'challenges:admin_subscription_edit' subscription.id %}" class="btn btn-warning">
                        <span class="material-icons">edit</span>
                        Edit Subscription
                    </a>
                    {% if subscription.status == 'active' %}
                    <a href="{% url 'challenges:admin_subscription_cancel' subscription.id  %}"
                        <span class="material-icons">cancel</span>
                        Cancel Subscription
                    </a>
                    {% endif %}
                    <a href="{% url 'challenges:admin_subscription_create' %}"
                        <span class="material-icons">add</span>
                        Create New Subscription
                    </a>
                    <a href="{% url 'challenges:admin_subscription_confirm_delete' subscription.id  %}"
                        <span class="material-icons">delete</span>
                        Delete Subscription
                    </a>
                </div>
            </div>
        </div>

        <!-- Status Information -->
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <span class="material-icons">info</span>
                    Status Information
                </h3>
            </div>
            <div class="card-content">
                <div class="status-info">
                    {% if subscription.status == 'active' %}
                        {% if subscription.is_active %}
                            <div class="status-item success">
                                <span class="material-icons">check_circle</span>
                                <span>Subscription is currently active</span>
                            </div>
                        {% else %}
                            <div class="status-item warning">
                                <span class="material-icons">warning</span>
                                <span>Subscription has expired</span>
                            </div>
                        {% endif %}
                    {% elif subscription.status == 'pending' %}
                        <div class="status-item info">
                            <span class="material-icons">pending</span>
                            <span>Payment is pending</span>
                        </div>
                    {% elif subscription.status == 'cancelled' %}
                        <div class="status-item warning">
                            <span class="material-icons">cancel</span>
                            <span>Subscription was cancelled</span>
                        </div>
                    {% elif subscription.status == 'expired' %}
                        <div class="status-item error">
                            <span class="material-icons">expired</span>
                            <span>Subscription has expired</span>
                        </div>
                    {% endif %}
                    
                    {% if subscription.is_expiring_soon and subscription.status == 'active' %}
                        <div class="status-item warning">
                            <span class="material-icons">schedule</span>
                            <span>Expires soon ({{ subscription.days_remaining }} days)</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
